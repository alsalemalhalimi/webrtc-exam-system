<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø·Ø§Ù„Ø¨ - Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø´Ø§Ø´Ø©</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .back-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            text-decoration: none;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .back-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }
        
        .content {
            padding: 30px;
        }
        
        .control-panel {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            border: 2px solid #e9ecef;
        }
        
        .input-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        input {
            padding: 15px 20px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            min-width: 200px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        input:focus {
            border-color: #28a745;
            outline: none;
            box-shadow: 0 0 0 3px rgba(40,167,69,0.1);
        }
        
        button {
            padding: 15px 25px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 160px;
        }
        
        .primary-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }
        
        .primary-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(40,167,69,0.3);
        }
        
        .success-btn {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
        }
        
        .success-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,123,255,0.3);
        }
        
        .danger-btn {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
        }
        
        .danger-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(220,53,69,0.3);
        }
        
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            opacity: 0.6;
        }
        
        .status {
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            border: 3px solid transparent;
        }
        
        .connected { 
            background: #d4edda; 
            color: #155724; 
            border-color: #c3e6cb;
        }
        
        .disconnected { 
            background: #f8d7da; 
            color: #721c24; 
            border-color: #f5c6cb;
        }
        
        .waiting { 
            background: #fff3cd; 
            color: #856404; 
            border-color: #ffeaa7;
        }
        
        .video-container {
            background: #000;
            border-radius: 15px;
            overflow: hidden;
            margin: 25px 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        video {
            width: 100%;
            max-width: 900px;
            display: block;
        }
        
        .users-panel {
            background: #e7f3ff;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid #b3d9ff;
        }
        
        .debug-panel {
            background: #1a1a1a;
            color: #00ff00;
            padding: 20px;
            border-radius: 10px;
            margin-top: 25px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid #333;
        }
        
        .debug-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            color: white;
        }
        
        .debug-controls button {
            padding: 8px 15px;
            font-size: 14px;
            min-width: auto;
            margin: 0 5px;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        
        .connection-info {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-right: 4px solid #007bff;
        }
        
        @media (max-width: 768px) {
            .input-group {
                flex-direction: column;
            }
            
            input, button {
                width: 100%;
                min-width: auto;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .header h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="/" class="back-btn">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
            <h1>ğŸ‘¨â€ğŸ“ Ø·Ø§Ù„Ø¨ - Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø´Ø§Ø´Ø©</h1>
            <p>Ø´Ø§Ø±Ùƒ Ø´Ø§Ø´ØªÙƒ Ù…Ø¹ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ Ø®Ù„Ø§Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</p>
        </div>
        
        <div class="content">
            <div class="control-panel">
                <div class="input-group">
                    <input type="text" id="nameInput" placeholder="Ø§Ø³Ù…Ùƒ" value="Ø·Ø§Ù„Ø¨">
                    <button onclick="joinRoom()" id="joinBtn" class="primary-btn">Ø§Ù†Ø¶Ù… Ù„Ù„ØºØ±ÙØ©</button>
                </div>

                <div id="status" class="status disconnected">ØºÙŠØ± Ù…ØªØµÙ„</div>

                <div class="connection-info">
                    <strong>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„:</strong>
                    <div id="connectionInfo">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...</div>
                </div>

                <div class="users-panel" id="usersPanel" style="display: none;">
                    <h3>ğŸ‘¥ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙŠ Ø§Ù„ØºØ±ÙØ©</h3>
                    <div id="usersContent"></div>
                </div>

                <div class="button-group">
                    <button onclick="startSharing()" id="shareBtn" class="success-btn" disabled>ğŸ¥ Ø¨Ø¯Ø¡ Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø´Ø§Ø´Ø©</button>
                    <button onclick="stopSharing()" id="stopBtn" class="danger-btn" disabled>ğŸ›‘ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©</button>
                    <button onclick="recreateOffer()" id="retryBtn" class="primary-btn" disabled>ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
                </div>
            </div>

            <div class="video-container">
                <video id="localVideo" autoplay muted playsinline></video>
            </div>
            
            <div class="debug-panel">
                <div class="debug-header">
                    <strong>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØµØ­ÙŠØ­:</strong>
                    <div class="debug-controls">
                        <button onclick="clearDebug()" class="primary-btn">Ù…Ø³Ø­</button>
                        <button onclick="toggleDebug()" class="success-btn">Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø±</button>
                    </div>
                </div>
                <div id="debugLog"></div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let localStream = null;
        let peerConnection = null;
        let connectionTimeout;
        const room = 'exam-room';
        let isSharing = false;
        let connectionAttempts = 0;
        const maxConnectionAttempts = 5;

        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ICE Servers Ø§Ù„Ù…Ø­Ø³Ù†Ø© Ù„Ù„Ø¥Ù†ØªØ±Ù†Øª
        const iceServers = [
            // STUN servers Ù…Ø¬Ø§Ù†ÙŠØ©
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:stun1.l.google.com:19302' },
            { urls: 'stun:stun2.l.google.com:19302' },
            { urls: 'stun:stun3.l.google.com:19302' },
            { urls: 'stun:stun4.l.google.com:19302' },
            
            // STUN servers Ø¥Ø¶Ø§ÙÙŠØ©
            { urls: 'stun:stun.voipbuster.com:3478' },
            { urls: 'stun:stun.voipstunt.com:3478' },
            { urls: 'stun:stun.sipgate.net:3478' },
            
            // TURN servers Ù…Ø¬Ø§Ù†ÙŠØ© (Ù…Ù‡Ù…Ø© Ù„Ù„Ø§ØªØµØ§Ù„ Ø¹Ø¨Ø± Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª)
            {
                urls: 'turn:openrelay.metered.ca:80',
                username: 'openrelayproject',
                credential: 'openrelayproject'
            },
            {
                urls: 'turn:openrelay.metered.ca:443',
                username: 'openrelayproject',
                credential: 'openrelayproject'
            },
            {
                urls: 'turn:openrelay.metered.ca:443?transport=tcp',
                username: 'openrelayproject',
                credential: 'openrelayproject'
            },
            {
                urls: 'turn:numb.viagenie.ca',
                username: 'webrtc@live.com',
                credential: 'password'
            }
        ];

        function debugLog(message) {
            const log = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            log.innerHTML += `<div><span style="color: #888;">[${timestamp}]</span> ${message}</div>`;
            log.scrollTop = log.scrollHeight;
            console.log(message);
        }

        function updateStatus(message, type = 'disconnected') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }

        function updateConnectionInfo(message) {
            document.getElementById('connectionInfo').textContent = message;
        }

        function clearDebug() {
            document.getElementById('debugLog').innerHTML = '';
        }

        function toggleDebug() {
            const debugPanel = document.querySelector('.debug-panel');
            debugPanel.style.display = debugPanel.style.display === 'none' ? 'block' : 'none';
        }

        function joinRoom() {
            const name = document.getElementById('nameInput').value || 'Ø·Ø§Ù„Ø¨';
            const joinBtn = document.getElementById('joinBtn');
            
            joinBtn.disabled = true;
            joinBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…...';
            
            socket.emit('join', { room, name, type: 'student' });
            updateStatus(`Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...`, 'waiting');
            debugLog(`ğŸ“¡ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØºØ±ÙØ©: ${room}`);
        }

        // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…
        socket.on('joined-success', (data) => {
            updateStatus(`âœ… Ù…ØªØµÙ„ - ${data.message}`, 'connected');
            document.getElementById('joinBtn').textContent = 'ØªÙ… Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…';
            document.getElementById('shareBtn').disabled = false;
            debugLog(`âœ… ${data.message} - Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: ${data.usersCount}`);
        });

        async function startSharing() {
            if (isSharing) return;
            
            try {
                updateStatus('ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø·Ù„Ø¨ Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø´Ø§Ø´Ø©...', 'waiting');
                updateConnectionInfo('Ø¬Ø§Ø±ÙŠ Ø·Ù„Ø¨ Ø¥Ø°Ù† Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø´Ø§Ø´Ø©...');
                document.getElementById('shareBtn').disabled = true;
                connectionAttempts = 0;
                
                // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ù…Ø¹ ØªØ­Ø³ÙŠÙ†Ø§Øª
                localStream = await navigator.mediaDevices.getDisplayMedia({
                    video: {
                        cursor: 'always',
                        displaySurface: 'window',
                        frameRate: { max: 25 }
                    },
                    audio: false
                });

                document.getElementById('localVideo').srcObject = localStream;
                updateStatus('ğŸ”— Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„...', 'waiting');
                updateConnectionInfo('Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§ØªØµØ§Ù„ WebRTC...');
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ø§ØªØµØ§Ù„ WebRTC Ù…Ø­Ø³Ù†
                peerConnection = new RTCPeerConnection({
                    iceServers: iceServers,
                    iceTransportPolicy: 'all',
                    bundlePolicy: 'max-bundle',
                    rtcpMuxPolicy: 'require'
                });

                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Øªracks Ù„Ù„Ø§ØªØµØ§Ù„ Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
                localStream.getTracks().forEach(track => {
                    track.onended = () => {
                        debugLog(`ğŸ›‘ Ø§Ù†ØªÙ‡Ù‰ track: ${track.kind}`);
                        stopSharing();
                    };
                    
                    const sender = peerConnection.addTrack(track, localStream);
                    debugLog(`âœ… Ø£Ø¶ÙØª track: ${track.kind} - ${sender ? 'Ù†Ø§Ø¬Ø­' : 'ÙØ§Ø´Ù„'}`);
                    
                    // ØªØ­Ø³ÙŠÙ† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
                    if (track.kind === 'video') {
                        const constraints = {
                            width: { max: 1280 },
                            height: { max: 720 },
                            frameRate: { max: 25 }
                        };
                        track.applyConstraints(constraints).catch(e => {
                            debugLog(`âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ·Ø¨ÙŠÙ‚ constraints: ${e.message}`);
                        });
                    }
                });

                // Ù…Ø¹Ø§Ù„Ø¬Ø© ICE Candidates
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        socket.emit('ice-candidate', {
                            room: room,
                            candidate: event.candidate
                        });
                        debugLog('ğŸ“¤ Ø£Ø±Ø³Ù„Øª ICE candidate');
                        updateConnectionInfo('Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„...');
                    }
                };

                // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
                peerConnection.onconnectionstatechange = () => {
                    const state = peerConnection.connectionState;
                    debugLog(`ğŸ”„ Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„: ${state}`);
                    updateConnectionInfo(`Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„: ${state}`);
                    
                    if (state === 'connected') {
                        updateStatus('âœ… Ù…ØªØµÙ„ Ø¨Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ - Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø«', 'connected');
                        connectionAttempts = 0;
                        clearTimeout(connectionTimeout);
                    } else if (state === 'disconnected' || state === 'failed') {
                        updateStatus('âš ï¸ Ø§Ù„Ø§ØªØµØ§Ù„ Ù…Ù†Ù‚Ø·Ø¹', 'waiting');
                        if (isSharing && connectionAttempts < maxConnectionAttempts) {
                            setTimeout(() => recreateOffer(), 2000);
                        }
                    }
                };

                // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ø±Ø¶
                await createAndSendOffer();
                document.getElementById('retryBtn').disabled = false;

            } catch (error) {
                updateStatus(`âŒ Ø®Ø·Ø£: ${error.message}`, 'disconnected');
                debugLog(`âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø´Ø§Ø´Ø©: ${error.message}`);
                document.getElementById('shareBtn').disabled = false;
                isSharing = false;
            }
        }

        async function createAndSendOffer() {
            if (!peerConnection) return;
            
            try {
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                
                socket.emit('offer', {
                    room: room,
                    offer: offer,
                    from: document.getElementById('nameInput').value
                });

                updateStatus('â³ Ø¬Ø§Ø±ÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨...', 'waiting');
                updateConnectionInfo('Ø¬Ø§Ø±ÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø§ØªØµØ§Ù„ Ù…Ù† Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨...');
                document.getElementById('stopBtn').disabled = false;
                isSharing = true;
                connectionAttempts++;
                
                debugLog(`ğŸ“¡ Ø£Ø±Ø³Ù„Øª Ø¹Ø±Ø¶ WebRTC (Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ${connectionAttempts})`);

                // Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø®Ù„Ø§Ù„ 10 Ø«ÙˆØ§Ù†ÙŠ
                connectionTimeout = setTimeout(() => {
                    if (peerConnection && peerConnection.connectionState !== 'connected' && isSharing) {
                        if (connectionAttempts < maxConnectionAttempts) {
                            debugLog('ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§ØªØµØ§Ù„...');
                            recreateOffer();
                        } else {
                            updateStatus('âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø¹Ø¯ Ø¹Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø§Øª', 'disconnected');
                            debugLog('âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø¹Ø¯ Ø¹Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø§Øª');
                        }
                    }
                }, 10000);

            } catch (error) {
                debugLog(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ø±Ø¶: ${error.message}`);
            }
        }

        async function recreateOffer() {
            if (!peerConnection || !isSharing) return;
            
            if (connectionAttempts >= maxConnectionAttempts) {
                updateStatus('âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø¹Ø¯ Ø¹Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø§Øª', 'disconnected');
                return;
            }
            
            try {
                debugLog(`ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ (${connectionAttempts + 1}/${maxConnectionAttempts})`);
                await createAndSendOffer();
            } catch (error) {
                debugLog(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©: ${error.message}`);
            }
        }

        // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ù…Ù† Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨
        socket.on('answer', async (data) => {
            if (peerConnection && isSharing) {
                try {
                    await peerConnection.setRemoteDescription(data.answer);
                    updateStatus('âœ… Ù…ØªØµÙ„ Ø¨Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ - Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø«', 'connected');
                    updateConnectionInfo('Ø§Ù„Ø§ØªØµØ§Ù„ Ù†Ø§Ø¬Ø­ - Ø¬Ø§Ø±ÙŠ Ø¨Ø« Ø§Ù„ÙÙŠØ¯ÙŠÙˆ');
                    debugLog('âœ… Ø§Ø³ØªÙ‚Ø¨Ù„Øª Ø¥Ø¬Ø§Ø¨Ø© Ù…Ù† Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨');
                    connectionAttempts = 0;
                    clearTimeout(connectionTimeout);
                } catch (error) {
                    debugLog(`âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©: ${error.message}`);
                }
            }
        });

        // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ ICE Candidates Ù…Ù† Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨
        socket.on('ice-candidate', async (data) => {
            if (peerConnection && isSharing) {
                try {
                    await peerConnection.addIceCandidate(data.candidate);
                    debugLog('ğŸ“¥ Ø§Ø³ØªÙ‚Ø¨Ù„Øª ICE candidate');
                    updateConnectionInfo('Ø¬Ø§Ø±ÙŠ ØªØ­Ø³ÙŠÙ† Ø¬ÙˆØ¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„...');
                } catch (error) {
                    debugLog(`âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© ICE candidate: ${error.message}`);
                }
            }
        });

        // Ø·Ù„Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ø±Ø¶
        socket.on('recreate-offer', () => {
            debugLog('ğŸ”„ Ø·Ù„Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ø±Ø¶ Ù…Ù† Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨');
            if (isSharing) {
                recreateOffer();
            }
        });

        function stopSharing() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            document.getElementById('localVideo').srcObject = null;
            updateStatus('Ù…Ø´Ø§Ø±ÙƒØ© Ù…ØªÙˆÙ‚ÙØ©', 'disconnected');
            updateConnectionInfo('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...');
            document.getElementById('shareBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('retryBtn').disabled = true;
            isSharing = false;
            connectionAttempts = 0;
            clearTimeout(connectionTimeout);
            debugLog('ğŸ›‘ Ø£ÙˆÙ‚ÙØª Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©');
        }

        // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
        socket.on('users-update', (users) => {
            const usersPanel = document.getElementById('usersPanel');
            const usersContent = document.getElementById('usersContent');
            
            if (users.length > 0) {
                usersPanel.style.display = 'block';
                usersContent.innerHTML = users.map(user => 
                    `<div style="padding: 10px; margin: 5px 0; background: white; border-radius: 5px; border-right: 4px solid ${user.type === 'student' ? '#28a745' : '#dc3545'};">
                        <strong>${user.name}</strong> (${user.type})
                    </div>`
                ).join('');
            } else {
                usersPanel.style.display = 'none';
            }
        });

        // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø§ØªØµØ§Ù„
        socket.on('connect', () => {
            debugLog('âœ… Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±');
            updateStatus('Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„...', 'waiting');
        });

        socket.on('disconnect', () => {
            updateStatus('Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„', 'disconnected');
            debugLog('âŒ Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±');
        });

        socket.on('connect_error', (error) => {
            debugLog(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ${error.message}`);
        });

        // Ù…Ù†Ø¹ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø© Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©
        window.addEventListener('beforeunload', (event) => {
            if (isSharing) {
                event.preventDefault();
                event.returnValue = 'Ø£Ù†Øª ØªÙ‚ÙˆÙ… Ø¨Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø´Ø§Ø´Ø©. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø©ØŸ';
            }
        });

        // Ø¬Ø¹Ù„ Ø§Ù„Ø¯ÙˆØ§Ù„ Ù…ØªØ§Ø­Ø© globally
        window.recreateOffer = recreateOffer;
    </script>
</body>
</html>